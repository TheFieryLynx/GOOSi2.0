\nsection{OSN 7 Ошибка типа «переполнение буфера». Выполнение произвольного кода на исполнимом стеке. Противодействие выполнению кода на стеке: «канарейка»,
DEP. Выполнение произвольного кода на неисполнимом стеке. Return-to-libc, return-orientedprogramming(ROP).}

\textbf{Ошибка типа «переполнение буфера»}
Программа осуществляет запись в буфер, размещенный на стеке, по неверному индексу, превышающему наибольший допустимый. Ошибка типична для языков Си и Си++, а также для ассемблера. Возможные последствия эксплуатации уязвимости: нарушение доступности — аварийное завершение или зависание программы; нарушение конфиденциальности, целостности и доступности — перехват потока управления, внедрение произвольного кода. \textbf{CWE оценивает вероятность эксплуатации как очень высокую.}

Для \textbf{эксплуатации переполнения}, атакующий пишет в буфер короткий участок исполнимого кода, который выполнит некое выбранное атакующим действие. Адрес возврата переписывается соответствующим адресом из буфера, заставляя процессор исполнять этот код при попытке возврата из процедуры.
\textit{(Язык Си никогда не проверяет выполняемые над буферами чтения и записи, допуская переполнение.)}


\textbf{Условия реализации атаки}
\begin{itemize}
    \item \textbf{Исполнимый стек:} внедряемый код размещён на стеке. Если система не позволяет выполнять код из диапазона адресов, относящегося к стеку, атака не удастся.
    \item \textbf{Относительно корректное завершение функции:} после того, как перезаписан адрес возврата и предшествующие ему значения в стеке, функция должна доработать до команды ret, чтобы выполнился внедряемый код.
    \item \textbf{Постоянные адреса: }в рамках последовательных запусков программы адреса объектов в стеке не должны меняться, т.к. иначе перезаписанный адрес возврата перестанет быть корректным, и вместо перехвата потока управления можно будет получить лишь аварийное завершение программы.
\end{itemize}

\textbf{Противодействие выполнению кода на стеке}

\textbf{Неисполнимый стек} (DEP) — технология, позволяющая помечать сегменты или страницы памяти стека как неисполняемые. При попытке передать управление на код, размещённый в такой памяти, происходит аварийное завершение процесса. Аппаратно поддерживается на уровне страничной трансляции во всех процессорах x86\_64, а также в более новых x86 и ARM. В более старых моделях x86 возможна более медленная и сопряжённая с дополнительными ограничениями на исполнимые файлы реализация с использованием сегментной трансляции.

\textbf{(DEP)} Когда системы стараются разделить память на записываемую и исполняемую, но не одновременно ту и другую. (обычно реализовано в аппаратной поддержке виртуальной памяти). 

\textbf{Обход DEP: return-to-libc}
Вместо передачи управления на код внутри буфера можно заменить адрес возврата на адрес известной библиотечной функции, например system из стандартной библиотеки Си. Она принимает один параметр (обычно через стек), адрес строки, представляющий собой команду для исполнения. Атакующий создает нужную команду и помещает адрес на неё в переполняемый буфер. Функция system(), будучи частью системной библиотеки, исполнима. Эксплойту не надо исполнять код из стека; достаточно прочитать команду с него.

\textbf{Канарейка }
Общая идея: проверять факт перезаписи стека непосредственно перед адресом возврата перед выходом из функции. «Канарейка» — как правило случайное значение, которое размещается на стеке перед адресом возврата. Перед выходом из функции происходит сравнение значения в стеке с исходным значением. Если значения не совпадают, программа аварийно завершается.

\textbf{Обход «канарейки» на стеке:}
\begin{enumerate}
    \item «Канарейка» проверяется только перед выходом из функции, однако перехват потока управления может быть осуществлён раньше (перезаписываемый указатель на функцию).
    \item «Канарейка» может быть перезаписана, если в функции есть ошибка CWE-123 (‘Write-what-where Condition’). Также в этом случае может быть перезаписан адрес возврата, а «канарейка» останется неизменной.
    \item Если программа содержит, например, ошибку CWE-126 (‘Buffer Over-read’), или возможны множественные попытки (brute force), то значение «канарейки» может быть извлечено из стека, после чего возможна эксплуатация переполнения буфера с известным значением «канарейки».
    \item Перехват обработчика исключения на Windows (SEH-эксплоит).
\end{enumerate}

\textbf{Противодействие:}
\begin{enumerate}
    \item \textbf{Рандомизация адресного пространства (ASLR)}. Делает случайной позицию стека и расположение в памяти библиотек и исполнимого кода. Они меняются при любом запуске пр-ммы, перезагрузке или их комбинации. Можно попытаться обойти защиту, используя только постоянные адреса.
    \item  \textbf{Return-oriented programming (ROP)}. \textbf{Гаджет} —  техника построения экслоита, при которой полезная нагрузка формируется в виде цепочки гаджетов с известными постоянным адресами. использует гаджеты - послед-ти команд в, заканчивающаяся командой RET. Каждый гаджет выполняет некую операцию (запись значения в регистр, сложение регистров, и т.п.)
    Для объединения гаджетов в одно целое используется длинная послед-ть адресов возврата (а также любых полезных и необходимых данных) записанных в стек в ходе переполнения буфера. Инструкции возврата прыгают с гаджета на гаджет, в то время как ф-ции вызываются редко (или никогда).
    \textbf{ Возвратно-ориентированное программирование (ROP) }— способ построения эксплоита, при котором полезная нагрузка формируется в виде цепочки гаджетов с известными постоянными адресами. 
\end{enumerate}